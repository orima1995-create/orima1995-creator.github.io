name: Post from Issue
on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: read

jobs:
  build-post:
    if: |
      github.event.issue.state == 'open' &&
      contains(join(github.event.issue.labels.*.name, ','), 'post')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate post (shop-style)
        env:
          TITLE:  ${{ github.event.issue.title }}
          BODY:   ${{ github.event.issue.body }}
          AUTHOR: ${{ github.event.issue.user.login }}
        run: |
          set -euo pipefail

          get_field () {
            awk -v key="$1" '
              $0 ~ "^"key"$" {getline; print; exit}
            ' <<<"$BODY" | sed 's/\r$//'
          }
          get_block () {
            awk -v key="$1" '
              $0 ~ "^"key"$" {flag=1; next}
              flag && NF {print; next}
              flag && !NF {exit}
            ' <<<"$BODY" | sed 's/\r$//'
          }

          BRAND=$(get_field "ãƒ–ãƒ©ãƒ³ãƒ‰")
          MODEL=$(get_field "ãƒ¢ãƒ‡ãƒ«å")
          CALIBER=$(get_field "ã‚­ãƒ£ãƒªãƒãƒ¼")
          WINDING=$(get_field "å·»ãä¸Šã’æ–¹å¼")
          CASE=$(get_field "ã‚±ãƒ¼ã‚¹å¾„ï¼ˆmmï¼‰" | tr -cd '0-9.')
          LUG=$(get_field "ãƒ©ã‚°å¹…ï¼ˆmmï¼‰"  | tr -cd '0-9.')
          MATERIAL=$(get_field "ç´ æ")
          ERA=$(get_field "è£½é€ å¹´ä»£")
          CATCH=$(get_field "ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ï¼ˆ1è¡Œï¼‰")
          PRICE_REF=$(get_field "å‚è€ƒå¸‚å ´ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰")
          VIDEO=$(get_field "å‹•ç”»URLï¼ˆä»»æ„ï¼‰")
          OWNER=$(get_field "å±•ç¤ºè€…ï¼ˆä»»æ„ï¼‰")

          FUNCS=$(get_block "æ©Ÿèƒ½ï¼ˆè©²å½“ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰" | tr '\n' ',' | sed 's/,$//')
          FUNCS_OTHER=$(get_field "æ©Ÿèƒ½ï¼ˆãã®ä»–ã®è©³ç´°ï¼‰")
          [ -n "$FUNCS_OTHER" ] && FUNCS="${FUNCS:+$FUNCS, }$FUNCS_OTHER"
          [ -z "$FUNCS" ] && FUNCS="ï¼ˆæœªè¨˜å…¥ï¼‰"

          PHOTOS_BLOCK=$(get_block "ç”»åƒï¼ˆã‚¹ãƒãƒ›ã‹ã‚‰æ·»ä»˜OKï¼‰")
          all_urls=$(echo "$PHOTOS_BLOCK" | grep -Eo '!\[[^]]*\]\(([^)]+)\)|https?://[^ )>"]+\.(jpg|jpeg|png|gif|webp)' | sed -E 's/!\[[^]]*\]\(([^)]+)\)/\1/g' || true)
          MAIN_PHOTO=$(echo "$all_urls" | head -n1 || true)
          GALLERY_URLS=$(echo "$all_urls" | tail -n +2 || true)

          COND_SRC=$(get_field "ä»•å…¥ã‚Œ")
          COND_STATE=$(get_field "çŠ¶æ…‹")
          COND_NOTE=$(get_block "ç‰¹è¨˜äº‹é …")
          COND_LAST=$(get_field "æœ€çµ‚æ•´å‚™")
          COND_NEXT=$(get_field "æ¨å¥¨æ¬¡å›OH")
          COMMENT=$(get_block "ã‚ªãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆæ¨ã—ãƒã‚¤ãƒ³ãƒˆï¼‰")

          # Video
          if [ -n "$VIDEO" ]; then
            if echo "$VIDEO" | grep -Eqi '\.(mp4|webm)(\?|$)'; then
              VIDEO_MD="<video controls src=\"${VIDEO}\" style=\"max-width:100%;height:auto;border-radius:8px\"></video>"
            else
              VIDEO_MD="[â–¶ å†ç”Ÿ](${VIDEO})"
            fi
          else
            VIDEO_MD="ï¼ˆæœªæŠ•ç¨¿ï¼‰"
          fi

          # Slug/path
          ts=$(date +%s%3N)
          safe () { echo "$1" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g;s/^-+|-+$//g'; }
          bslug=$(safe "$BRAND"); mslug=$(safe "$MODEL"); cslug=$(safe "$CALIBER")
          dir="posts/${bslug}"
          file="${dir}/${bslug}-${mslug}-${cslug}-${ts}.md"
          mkdir -p "$dir"

          # Condition block
          COND_BLOCK=""
          if [ -n "${COND_SRC}${COND_STATE}${COND_NOTE}${COND_LAST}${COND_NEXT}" ]; then
            COND_BLOCK=$(
              printf "## ğŸ” Condition\n\n"
              [ -n "$COND_SRC"   ] && printf "- ä»•å…¥ã‚Œï¼š%s\n"     "$COND_SRC"
              [ -n "$COND_STATE" ] && printf "- çŠ¶æ…‹ï¼š%s\n"       "$COND_STATE"
              [ -n "$COND_NOTE"  ] && printf "- ç‰¹è¨˜äº‹é …ï¼š%s\n"   "$COND_NOTE"
              [ -n "$COND_LAST"  ] && printf "- æœ€çµ‚æ•´å‚™ï¼š%s\n"   "$COND_LAST"
              [ -n "$COND_NEXT"  ] && printf "- æ¨å¥¨æ¬¡å›OHï¼š%s\n" "$COND_NEXT"
            )
          fi

          # Gallery grid
          GALLERY_HTML=""
          if [ -n "$GALLERY_URLS" ]; then
            GALLERY_HTML="<div class=\"grid\">"
            while IFS= read -r u; do
              [ -z "$u" ] && continue
              GALLERY_HTML="${GALLERY_HTML}\n  <figure><img src=\"${u}\" alt=\"photo\"></figure>"
            done <<< "$GALLERY_URLS"
            GALLERY_HTML="${GALLERY_HTML}\n</div>"
          else
            GALLERY_HTML="ï¼ˆç”»åƒã¯1æšã®ã¿ï¼‰"
          fi

          # Owner comment â€” éŸ³ç’°/18K/è£è“‹å©ãç³»ã¨ã®å·®åˆ†ãŒæ›¸ã‘ã‚‹â€œæ¨ã—ãƒã‚¤ãƒ³ãƒˆâ€æ¬„
          [ -z "$COMMENT" ] && COMMENT="Time-O-Voxã®é­…åŠ›ã¯â€œéŸ³ç’°â€ã€‚ç´„6ç§’ã®å‡è³ªã§æ¾„ã‚“ã é³´å‹•ã€è£è“‹å©ãç³»ã¨ã¯é•ã†ä¼¸ã³ã‚„ã‹ãªéŸ¿ãã€‚18Kã‚±ãƒ¼ã‚¹ãŒå…±é³´ã—ã¦éŸ³ã«ä¸¸ã¿ã‚’ä¸ãˆã¾ã™ã€‚"

          PRICE_LINE="${PRICE_REF:-(å‚è€ƒä¾¡æ ¼è¨˜è¼‰ãªã—)}"
          TITLE_FULL="${BRAND} ${MODEL}"

          cat > "$file" <<MD
<style>
  .hero img{width:100%;height:auto;border-radius:10px}
  .badges{display:flex;flex-wrap:wrap;gap:.5rem;margin:.75rem 0}
  .badge{background:#f2f2f2;border-radius:999px;padding:.25rem .6rem;font-size:.85rem}
  .spec{display:grid;grid-template-columns:1fr 1fr;gap:.5rem 1rem;margin:0}
  .spec dt{font-weight:600}
  .spec dd{margin:0 0 .4rem 0}
  .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem}
  .grid img{width:100%;height:auto;border-radius:8px}
  @media(max-width:720px){.spec{grid-template-columns:1fr} .grid{grid-template-columns:1fr 1fr}}
  .band{background:#fafafa;border:1px solid #eee;border-radius:8px;padding:.75rem;margin:1rem 0}
</style>

# ${TITLE_FULL}

<div class="hero">
${MAIN_PHOTO:+<img src="${MAIN_PHOTO}" alt="${TITLE_FULL}">}
</div>

${CATCH:+**${CATCH}**}

<div class="band">
<strong>å‚è€ƒå¸‚å ´ä¾¡æ ¼ï¼š</strong>${PRICE_LINE}
<div class="badges">
  <span class="badge">${MATERIAL}</span>
  <span class="badge">${WINDING:-â€”}</span>
  <span class="badge">${ERA:-â€”}</span>
  <span class="badge">${FUNCS}</span>
</div>
</div>

## ğŸ“‹ ã‚¹ãƒšãƒƒã‚¯
<dl class="spec">
  <dt>ãƒ–ãƒ©ãƒ³ãƒ‰</dt><dd>${BRAND}</dd>
  <dt>ãƒ¢ãƒ‡ãƒ«</dt><dd>${MODEL}</dd>
  <dt>ã‚­ãƒ£ãƒªãƒãƒ¼</dt><dd>${CALIBER:-ï¼ˆæœªè¨˜å…¥ï¼‰}</dd>
  <dt>å·»ãä¸Šã’æ–¹å¼</dt><dd>${WINDING:-ï¼ˆæœªè¨˜å…¥ï¼‰}</dd>
  <dt>ã‚±ãƒ¼ã‚¹å¾„</dt><dd>${CASE} mm</dd>
  <dt>ãƒ©ã‚°å¹…</dt><dd>${LUG:-â€”} mm</dd>
  <dt>ç´ æ</dt><dd>${MATERIAL}</dd>
  <dt>è£½é€ å¹´ä»£</dt><dd>${ERA:-ï¼ˆæœªè¨˜å…¥ï¼‰}</dd>
  <dt>æ©Ÿèƒ½</dt><dd>${FUNCS}</dd>
</dl>

## ğŸ“¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼
${GALLERY_HTML}

## ğŸ¥ å‹•ç”»
${VIDEO_MD}

${COND_BLOCK:+\n${COND_BLOCK}\n}

## ğŸ—£ ã‚ªãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
> ${COMMENT}

---
**ã•ã‚‰ã«è©³ã—ã„ç ”ç©¶ãƒãƒ¼ãƒˆ â†’** /blog/
<br><br>
å±•ç¤ºè€…ï¼š${OWNER:-åŒ¿å}
MD

          # index ã‚’å…ˆé ­æ›´æ–°
          idx="posts/index.md"
          link="- [${TITLE_FULL}](/${file})"
          mkdir -p posts
          if [ -f "$idx" ]; then
            grep -qF "$link" "$idx" || (printf "%s\n\n" "$link" | cat - "$idx" > "$idx.tmp" && mv "$idx.tmp" "$idx")
          else
            printf "# æœ€æ–°æŠ•ç¨¿\n\n%s\n" "$link" > "$idx"
          fi

          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$file" "$idx"
          git commit -m "post: ${TITLE_FULL}" || true
          git push
