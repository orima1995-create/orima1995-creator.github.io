name: Publish from Issue (Watch)

on:
  issues:
    types: [opened, edited, labeled]

permissions:
  contents: write
  issues: read

jobs:
  build:
    if: |
      github.event.issue.state == 'open' &&
      (
        contains(github.event.issue.labels.*.name, 'publish')
      )
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Compose Markdown from Issue
        id: compose
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const body = issue.body || '';

            // ä¾¿åˆ©ãƒ‘ãƒ¼ã‚µï¼š`### é …ç›®å` ã®æ¬¡ã®æ®µè½ã‚’æŠœã
            function sect(label){
              const re = new RegExp(`(?<=${label}\\s*)[\\s\\S]*?(?=\\n\\n###|$)`,'i');
              const m = body.match(re); return m ? m[0].trim() : '';
            }

            // ãƒ•ã‚©ãƒ¼ãƒ ã®è‡ªå‹•ä»˜ä¸ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼ˆä¸Šã®watch.ymlã®IDã¨åˆã‚ã›ã‚‹ï¼‰
            const get = id => {
              const re = new RegExp(`(?<=${id}:\\s*)[\\s\\S]*?(?=\\n\\n\\w+:|$)`,'i');
              const m = body.match(re); return m ? m[0].trim() : '';
            };

            // GitHubãƒ•ã‚©ãƒ¼ãƒ ã¯æœ¬æ–‡ã«ä¸‹è¨˜ã®ã‚ˆã†ãªãƒ˜ãƒƒãƒ€ã‚’ä»˜ã‘ã¾ã™ã€‚ä¿é™ºã¨ã—ã¦è¦‹å‡ºã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚æ‹¾ã†
            const brandModel = get('ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ãƒ¢ãƒ‡ãƒ«å') || sect('ãƒ–ãƒ©ãƒ³ãƒ‰ï¼ãƒ¢ãƒ‡ãƒ«å') || '';
            const caliber    = get('ã‚­ãƒ£ãƒªãƒãƒ¼') || sect('ã‚­ãƒ£ãƒªãƒãƒ¼') || '';
            const winding    = get('å·»ãä¸Šã’æ–¹å¼') || sect('å·»ãä¸Šã’æ–¹å¼') || '';
            const material   = get('ã‚±ãƒ¼ã‚¹ç´ æ') || sect('ã‚±ãƒ¼ã‚¹ç´ æ') || '';
            const caseSize   = get('ã‚±ãƒ¼ã‚¹å¾„ï¼ˆmmï¼‰') || sect('ã‚±ãƒ¼ã‚¹å¾„ï¼ˆmmï¼‰') || '';
            const lug        = get('ãƒ©ã‚°å¹…ï¼ˆmmï¼‰') || sect('ãƒ©ã‚°å¹…ï¼ˆmmï¼‰') || '';
            const year       = get('è£½é€ å¹´ä»£') || sect('è£½é€ å¹´ä»£') || '';
            const tagline    = get('ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ï¼ˆ1è¡Œï¼‰') || sect('ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼') || '';
            const owner      = get('å±•ç¤ºè€…åï¼ˆä»»æ„ï¼‰') || sect('å±•ç¤ºè€…å') || '';
            const comment    = get('è‡ªç”±ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆé­…åŠ›ä¸­å¿ƒï¼‰') || sect('è‡ªç”±ã‚³ãƒ¡ãƒ³ãƒˆ') || '';
            const provenance = get('ä»•å…¥ã‚ŒçµŒè·¯ï¼ˆä»»æ„ï¼‰') || sect('ä»•å…¥ã‚ŒçµŒè·¯') || '';
            const cond       = get('çŠ¶æ…‹ï¼ˆä»»æ„ï¼‰') || sect('çŠ¶æ…‹') || '';
            const notes      = get('ç‰¹è¨˜äº‹é …ï¼ˆä»»æ„ï¼‰') || sect('ç‰¹è¨˜äº‹é …') || '';
            const lastServ   = get('æœ€çµ‚æ•´å‚™æ­´ï¼ˆä»»æ„ï¼‰') || sect('æœ€çµ‚æ•´å‚™æ­´') || '';
            const nextServ   = get('æ¬¡å›OHæ¨å¥¨æ™‚æœŸï¼ˆä»»æ„ï¼‰') || sect('æ¬¡å›OHæ¨å¥¨æ™‚æœŸ') || '';
            const video      = get('å‹•ç”»URLï¼ˆä»»æ„ï¼‰') || sect('å‹•ç”»') || '';

            // ç”»åƒURLæŠ½å‡ºï¼ˆIssueæœ¬æ–‡ã«è²¼ã£ãŸç”»åƒ `![](...)` ã‚’ã‚®ãƒ£ãƒ©ãƒªãƒ¼ã¨ã—ã¦åˆ©ç”¨ï¼‰
            const imgUrls = [...body.matchAll(/!\[[^\]]*\]\((https?:\/\/[^\s)]+)\)/g)].map(m => m[1]);
            const photosBlock = imgUrls.map(url => `![Photo](${url})`).join('\n');

            // ã‚¹ãƒ©ãƒƒã‚°ï¼šåŠè§’è‹±æ•°ãƒ»ãƒã‚¤ãƒ•ãƒ³ã«æ­£è¦åŒ–
            const toSlug = s => (s || '').toLowerCase()
              .replace(/[^\p{Letter}\p{Number}]+/gu,'-')
              .replace(/^-+|-+$/g,'');
            const slug = `${toSlug(brandModel || 'watch')}-${toSlug(caliber)}-${issue.number}`;

            // Conditionï¼ˆä»»æ„è¡¨ç¤ºï¼‰
            let conditionMd = '';
            const condLines = [];
            if (provenance) condLines.push(`- ä»•å…¥ã‚Œï¼š${provenance}`);
            if (cond)       condLines.push(`- çŠ¶æ…‹ï¼š${cond}`);
            if (notes)      condLines.push(`- ç‰¹è¨˜äº‹é …ï¼š${notes}`);
            if (lastServ)   condLines.push(`- æœ€çµ‚æ•´å‚™ï¼š${lastServ}`);
            if (nextServ)   condLines.push(`- æ¨å¥¨æ¬¡å›OHï¼š${nextServ}`);
            if (condLines.length) {
              conditionMd = `\n\n---\n\n## ğŸ” Condition\n${condLines.join('\n')}\n`;
            }

            // ãƒ¡ã‚¤ãƒ³ãƒ•ã‚©ãƒˆï¼ˆå…ˆé ­ï¼‰
            const mainPhoto = imgUrls[0] ? `\n\n![Main Photo](${imgUrls[0]})\n` : '';

            // ãƒ•ãƒ­ãƒ³ãƒˆãƒã‚¿ãƒ¼ + æœ¬æ–‡ï¼ˆJekyllãŒHTMLåŒ–ï¼‰
            const content = `---\ntitle: ${brandModel}\nlayout: default\n---\n\n# ${brandModel}\n${mainPhoto}\n**${tagline}**\n\nå‚è€ƒå¸‚å ´ä¾¡æ ¼ï¼š$4,500ã€œ$6,000\n\n---\n\n## ğŸ“‹ ã‚¹ãƒšãƒƒã‚¯\n- ãƒ–ãƒ©ãƒ³ãƒ‰ï¼š${brandModel.split(' ')[0] || ''}\n- ã‚­ãƒ£ãƒªãƒãƒ¼ï¼š${caliber}\n- å·»ãä¸Šã’æ–¹å¼ï¼š${winding}\n- ã‚±ãƒ¼ã‚¹ç´ æï¼š${material}\n- ã‚±ãƒ¼ã‚¹å¾„ï¼š${caseSize}mm\n- ãƒ©ã‚°å¹…ï¼š${lug}mm\n- è£½é€ å¹´ä»£ï¼š${year}\n\n---\n\n## ğŸ“¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼\n${photosBlock || 'ï¼ˆæº–å‚™ä¸­ï¼‰'}\n\n---\n\n## â–¶ å‹•ç”»\n${video ? `[â–¶ è¦‹ã‚‹](${video})` : 'ï¼ˆæœªæŠ•ç¨¿ï¼‰'}\n${conditionMd}\n\n---\n\n## ğŸ—£ ã‚ªãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ\n${comment || 'ï¼ˆæº–å‚™ä¸­ï¼‰'}\n\nå±•ç¤ºè€…ï¼š${owner || 'åŒ¿å'}\n`;

            core.setOutput('filename', `posts/${slug}.md`);
            core.setOutput('content', Buffer.from(content, 'utf8').toString('base64'));
            core.setOutput('slug', slug);

      - name: Create or update post file
        uses: peter-evans/create-or-update-file@v3
        with:
          path: ${{ steps.compose.outputs.filename }}
          message: "post: ${{ steps.compose.outputs.slug }}"
          content: ${{ steps.compose.outputs.content }}
          encoding: base64

      - name: Rebuild posts index
        id: rebuild
        uses: actions/github-script@v7
        with:
          script: |
            const {owner, repo} = context.repo;
            async function list(dir) {
              const { data } = await github.rest.repos.getContent({owner, repo, path: dir});
              let files = [];
              for (const item of data) {
                if (item.type === 'dir') {
                  files = files.concat(await list(item.path));
                } else if (item.type === 'file' && item.name.endsWith('.md')) {
                  files.push(item.path);
                }
              }
              return files;
            }
            const files = (await list('posts')).sort();
            const lines = [
              '---',
              'title: Posts',
              'layout: default',
              '---',
              '',
              '# æœ€æ–°æŠ•ç¨¿',
              ''
            ];
            for (const p of files.reverse()) lines.push(`- [${decodeURI(p.split('/').pop().replace(/\\.md$/,''))}](/${p.replace(/^/,'')})`);
            const indexMd = lines.join('\n') + '\n';
            return { content: Buffer.from(indexMd,'utf8').toString('base64') };

      - name: Update posts/index.md
        uses: peter-evans/create-or-update-file@v3
        with:
          path: posts/index.md
          message: "chore: rebuild posts index"
          content: ${{ steps.rebuild.outputs.result.content }}
          encoding: base64
