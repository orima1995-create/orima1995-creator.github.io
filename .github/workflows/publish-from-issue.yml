name: Post from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  build_post:
    if: contains(github.event.issue.labels.*.name, 'post')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Jekyll post from issue
        id: build
        run: |
          TITLE="${{ github.event.issue.title }}"
          NUMBER="${{ github.event.issue.number }}"
          DATE=$(date +"%Y-%m-%d %H:%M:%S %z")
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -e 's/ /-/g' -e 's/[^a-z0-9\-]//g')
          FILE="_posts/$(date +%Y-%m-%d)-${SLUG}-${NUMBER}.md"

          BODY="${{ github.event.issue.body }}"

          # 画像と動画を抽出
          MAIN_PHOTO=$(echo "$BODY" | grep -oE 'https?://[^ )]+(jpg|jpeg|png|gif)' | head -n1 || true)
          GALLERY=$(echo "$BODY" | grep -oE 'https?://[^ )]+(jpg|jpeg|png|gif)' | tail -n +2 || true)
          VIDEO=$(echo "$BODY" | grep -oE 'https?://[^ )]+(mp4|mov|webm|gifv)' | head -n1 || true)

          # Condition欄を抽出（あれば）
          CONDITION=$(echo "$BODY" | sed -n '/Condition/,$p')

          # Markdown本文生成
          cat > "$FILE" <<MD
---
layout: post
title: "${TITLE}"
date: ${DATE}
categories: watch
tags: [Vintage, Alarm, Chronometre]
---

# ${TITLE}

${MAIN_PHOTO:+![Main Photo](${MAIN_PHOTO})}

---

## 📋 スペック
${BODY}

---

## 📸 ギャラリー
${GALLERY:+$(echo "$GALLERY" | sed 's|^|![](|; s|$|)|')}

---

## 🎥 動画
${VIDEO:+[▶ 再生リンク](${VIDEO})}

${CONDITION:+
---
## 🔍 Condition
${CONDITION}
}

---

## 🗣 オーナーコメント
> （Issue本文のコメント欄を引用）

---

## 🔗 関連リンク
- [さらに詳しい研究ノートはこちら](/blog/)
MD

          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add _posts/
          git commit -m "Add post from issue #${{ github.event.issue.number }}" || echo "nothing to commit"
          git push
