name: Post from Issue

on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: read

jobs:
  build_post:
    if: contains(github.event.issue.labels.*.name, 'post')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Jekyll post from issue
        id: build
        run: |
          TITLE="${{ github.event.issue.title }}"
          NUMBER="${{ github.event.issue.number }}"
          DATE=$(date +"%Y-%m-%d %H:%M:%S %z")
          SLUG=$(echo "$TITLE" | tr '[:upper:]' '[:lower:]' | sed -e 's/ /-/g' -e 's/[^a-z0-9\-]//g')
          FILE="_posts/$(date +%Y-%m-%d)-${SLUG}-${NUMBER}.md"

          BODY="${{ github.event.issue.body }}"

          # ç”»åƒã¨å‹•ç”»ã‚’æŠ½å‡º
          MAIN_PHOTO=$(echo "$BODY" | grep -oE 'https?://[^ )]+(jpg|jpeg|png|gif)' | head -n1 || true)
          GALLERY=$(echo "$BODY" | grep -oE 'https?://[^ )]+(jpg|jpeg|png|gif)' | tail -n +2 || true)
          VIDEO=$(echo "$BODY" | grep -oE 'https?://[^ )]+(mp4|mov|webm|gifv)' | head -n1 || true)

          # Conditionæ¬„ã‚’æŠ½å‡ºï¼ˆã‚ã‚Œã°ï¼‰
          CONDITION=$(echo "$BODY" | sed -n '/Condition/,$p')

          # Markdownæœ¬æ–‡ç”Ÿæˆ
          cat > "$FILE" <<MD
---
layout: post
title: "${TITLE}"
date: ${DATE}
categories: watch
tags: [Vintage, Alarm, Chronometre]
---

# ${TITLE}

${MAIN_PHOTO:+![Main Photo](${MAIN_PHOTO})}

---

## ðŸ“‹ ã‚¹ãƒšãƒƒã‚¯
${BODY}

---

## ðŸ“¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼
${GALLERY:+$(echo "$GALLERY" | sed 's|^|![](|; s|$|)|')}

---

## ðŸŽ¥ å‹•ç”»
${VIDEO:+[â–¶ å†ç”Ÿãƒªãƒ³ã‚¯](${VIDEO})}

${CONDITION:+
---
## ðŸ” Condition
${CONDITION}
}

---

## ðŸ—£ ã‚ªãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
> ï¼ˆIssueæœ¬æ–‡ã®ã‚³ãƒ¡ãƒ³ãƒˆæ¬„ã‚’å¼•ç”¨ï¼‰

---

## ðŸ”— é–¢é€£ãƒªãƒ³ã‚¯
- [ã•ã‚‰ã«è©³ã—ã„ç ”ç©¶ãƒŽãƒ¼ãƒˆã¯ã“ã¡ã‚‰](/blog/)
MD

          echo "file=$FILE" >> $GITHUB_OUTPUT

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add _posts/
          git commit -m "Add post from issue #${{ github.event.issue.number }}" || echo "nothing to commit"
          git push
