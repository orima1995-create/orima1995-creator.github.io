name: Post from Issue
on:
  issues:
    types: [opened, edited]

permissions:
  contents: write
  issues: read

jobs:
  build-post:
    if: |
      github.event.issue.state == 'open' &&
      contains(join(github.event.issue.labels.*.name, ','), 'post')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate post from issue form
        env:
          TITLE: ${{ github.event.issue.title }}
          BODY: ${{ github.event.issue.body }}
          AUTHOR: ${{ github.event.issue.user.login }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail

          # -------- helpers --------
          get_field () {
            # ç›´å¾Œã®è¡Œã‚’1ã¤æ‹¾ã†ï¼ˆIssue Formsã¯ã€Œãƒ©ãƒ™ãƒ«è¡Œã®æ¬¡è¡Œã«å€¤ã€ãŒå…¥ã‚‹ï¼‰
            awk -v key="$1" '
              $0 ~ "^"key"$" {getline; print; exit}
            ' <<<"$BODY" | sed 's/\r$//'
          }

          get_block () {
            # ãƒ©ãƒ™ãƒ«è¡Œã®æ¬¡è¡Œã‹ã‚‰ç©ºè¡Œ or æ¬¡ã®è¦‹å‡ºã—ã¾ã§ã‚’ã¾ã¨ã‚ã¦æ‹¾ã†
            awk -v key="$1" '
              $0 ~ "^"key"$" {flag=1; next}
              flag && NF {print; next}
              flag && !NF {exit}
            ' <<<"$BODY" | sed 's/\r$//'
          }

          # -------- extract --------
          BRAND=$(get_field "ãƒ–ãƒ©ãƒ³ãƒ‰")
          MODEL=$(get_field "ãƒ¢ãƒ‡ãƒ«å")
          CALIBER=$(get_field "ã‚­ãƒ£ãƒªãƒãƒ¼")
          WINDING=$(get_field "å·»ãä¸Šã’æ–¹å¼")
          CASE=$(get_field "ã‚±ãƒ¼ã‚¹å¾„ï¼ˆmmï¼‰")
          LUG=$(get_field "ãƒ©ã‚°å¹…ï¼ˆmmï¼‰")
          MATERIAL=$(get_field "ç´ æ")
          ERA=$(get_field "è£½é€ å¹´ä»£")
          CATCH=$(get_field "ã‚­ãƒ£ãƒƒãƒã‚³ãƒ”ãƒ¼ï¼ˆ1è¡Œï¼‰")
          PRICE_REF=$(get_field "å‚è€ƒå¸‚å ´ä¾¡æ ¼ï¼ˆä»»æ„ï¼‰")
          VIDEO=$(get_field "å‹•ç”»URLï¼ˆä»»æ„ï¼‰")
          OWNER=$(get_field "å±•ç¤ºè€…ï¼ˆä»»æ„ï¼‰")

          FUNCS=$(get_block "æ©Ÿèƒ½ï¼ˆè©²å½“ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰" | tr '\n' ',' | sed 's/,$//')
          PHOTOS_BLOCK=$(get_block "ç”»åƒï¼ˆã‚¹ãƒãƒ›ã‹ã‚‰æ·»ä»˜OKï¼‰")
          COND_SRC=$(get_field "ä»•å…¥ã‚Œ")
          COND_STATE=$(get_field "çŠ¶æ…‹")
          COND_NOTE=$(get_block "ç‰¹è¨˜äº‹é …")
          COND_LAST=$(get_field "æœ€çµ‚æ•´å‚™")
          COND_NEXT=$(get_field "æ¨å¥¨æ¬¡å›OH")
          COMMENT=$(get_block "ã‚ªãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ")

          # -------- photos (pick first as main, list all as gallery) --------
          # ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ç”»åƒ ![](URL) or ç›´æ¥URLï¼ˆjpg/png/gif/webpï¼‰
          all_urls=$(echo "$PHOTOS_BLOCK" | grep -Eo '!\[[^]]*\]\(([^)]+)\)|https?://[^ )>"]+\.(jpg|jpeg|png|gif|webp)' | sed -E 's/!\[[^]]*\]\(([^)]+)\)/\1/g')
          MAIN_PHOTO=$(echo "$all_urls" | head -n1 || true)
          GALLERY=""
          if [ -n "$all_urls" ]; then
            while IFS= read -r u; do
              [ "$u" = "$MAIN_PHOTO" ] && continue
              GALLERY="${GALLERY}\n![Photo](${u})"
            done <<< "$all_urls"
          fi

          # -------- video (YouTube shortlink -> embed) --------
          VIDEO_MD=""
          if [ -n "$VIDEO" ]; then
            VIDEO_MD="[â–¶ è¦‹ã‚‹](${VIDEO})"
          else
            VIDEO_MD="ï¼ˆæœªæŠ•ç¨¿ï¼‰"
          fi

          # -------- condition block --------
          COND_BLOCK=""
          if [ -n "${COND_SRC}${COND_STATE}${COND_NOTE}${COND_LAST}${COND_NEXT}" ]; then
            COND_BLOCK=$(
              printf "\n---\n\n## ğŸ” Condition\n"
              [ -n "$COND_SRC"   ] && printf "- ä»•å…¥ã‚Œï¼š%s\n"     "$COND_SRC"
              [ -n "$COND_STATE" ] && printf "- çŠ¶æ…‹ï¼š%s\n"       "$COND_STATE"
              [ -n "$COND_NOTE"  ] && printf "- ç‰¹è¨˜äº‹é …ï¼š%s\n"   "$COND_NOTE"
              [ -n "$COND_LAST"  ] && printf "- æœ€çµ‚æ•´å‚™ï¼š%s\n"   "$COND_LAST"
              [ -n "$COND_NEXT"  ] && printf "- æ¨å¥¨æ¬¡å›OHï¼š%s\n" "$COND_NEXT"
            )
          fi

          # -------- slug / path --------
          ts=$(date +%s%3N)
          safe () { echo "$1" | tr '[:upper:]' '[:lower:]' | sed -E 's/[^a-z0-9]+/-/g;s/^-+|-+$//g'; }
          brand_slug=$(safe "$BRAND")
          model_slug=$(safe "$MODEL")
          cal_slug=$(safe "$CALIBER")
          slug="${brand_slug}-${model_slug}-${cal_slug}-${ts}"
          dir="posts/${brand_slug}"
          file="${dir}/${slug}.md"

          mkdir -p "$dir"

          # -------- template --------
          PRICE_LINE="${PRICE_REF:-(å‚è€ƒä¾¡æ ¼è¨˜è¼‰ãªã—)}"
          FUNCS_LINE="${FUNCS:-ï¼ˆæœªè¨˜å…¥ï¼‰}"
          CATCH_LINE="${CATCH:-}"

          cat > "$file" <<MD
# ${BRAND} ${MODEL}

$( [ -n "$MAIN_PHOTO" ] && printf '![Main](%s)\n\n' "$MAIN_PHOTO" )

${CATCH_LINE:+**${CATCH_LINE}**}

å‚è€ƒå¸‚å ´ä¾¡æ ¼ï¼š${PRICE_LINE}

---

## ğŸ“‹ ã‚¹ãƒšãƒƒã‚¯
- ãƒ–ãƒ©ãƒ³ãƒ‰ï¼š${BRAND}
- ãƒ¢ãƒ‡ãƒ«ï¼š${MODEL}
- ã‚­ãƒ£ãƒªãƒãƒ¼ï¼š${CALIBER:-ï¼ˆæœªè¨˜å…¥ï¼‰}
- å·»ãä¸Šã’æ–¹å¼ï¼š${WINDING:-ï¼ˆæœªè¨˜å…¥ï¼‰}
- ã‚±ãƒ¼ã‚¹å¾„ï¼š${CASE}mm
- ãƒ©ã‚°å¹…ï¼š${LUG:-ï¼ˆæœªè¨˜å…¥ï¼‰}mm
- ç´ æï¼š${MATERIAL}
- è£½é€ å¹´ä»£ï¼š${ERA:-ï¼ˆæœªè¨˜å…¥ï¼‰}
- æ©Ÿèƒ½ï¼š${FUNCS_LINE}

---

## ğŸ“¸ ã‚®ãƒ£ãƒ©ãƒªãƒ¼
${GALLERY:-ï¼ˆç”»åƒã¯1æšã®ã¿ï¼‰}

---

## ğŸ¥ å‹•ç”»
${VIDEO_MD}
${COND_BLOCK}

---

## ğŸ—£ ã‚ªãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ
> ${COMMENT:-ï¼ˆæœªè¨˜å…¥ï¼‰}

å±•ç¤ºè€…ï¼š${OWNER:-åŒ¿å}
MD

          # -------- posts/index.md æ›´æ–°ï¼ˆå…ˆé ­ã«è¿½åŠ ï¼‰--------
          idx="posts/index.md"
          titleline="- [${BRAND} ${MODEL}](/${file})"
          if [ -f "$idx" ]; then
            # å…ˆé ­ã«å·®ã—è¾¼ã¿ï¼ˆé‡è¤‡é˜²æ­¢ï¼‰
            grep -qF "$titleline" "$idx" || (printf "%s\n\n" "$titleline" | cat - "$idx" > "$idx.tmp" && mv "$idx.tmp" "$idx")
          else
            mkdir -p "posts"
            printf "# æœ€æ–°æŠ•ç¨¿\n\n%s\n" "$titleline" > "$idx"
          fi

          # -------- commit & push --------
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "$file" "$idx"
          git commit -m "post: ${BRAND} ${MODEL} (${slug})" || true
          git push

      - name: Comment with link
        env:
          REPO: ${{ github.repository }}
        run: |
          url="https://raw.githubusercontent.com/${REPO}/main/posts/index.md"
          echo "ç”Ÿæˆã¨ä¸€è¦§æ›´æ–°ãŒå®Œäº†ã—ã¾ã—ãŸ: ${url}"
